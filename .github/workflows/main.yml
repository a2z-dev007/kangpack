name: ğŸš€ Kangpack Production Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: kangpack-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted

    defaults:
      run:
        shell: bash

    steps:
      - name: ğŸ“¥ Checkout Latest Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node (with cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # =========================
      # BACKEND BUILD
      # =========================
      - name: ğŸ“¦ Install Backend Deps
        working-directory: backend
        run: npm ci

      - name: ğŸ— Build Backend (TypeScript)
        working-directory: backend
        run: npm run build

      # =========================
      # FRONTEND BUILD
      # =========================
      - name: ğŸ“¦ Install Frontend Deps
        working-directory: frontend
        run: npm ci

      - name: ğŸ— Build Next.js
        working-directory: frontend
        run: npm run build

      # =========================
      # PM2 DEPLOY
      # =========================
      - name: ğŸ” Reload Apps with PM2
        run: |
          pm2 start ecosystem.config.js || pm2 reload ecosystem.config.js
          pm2 save

      - name: ğŸ“Š PM2 Status
        run: pm2 list
